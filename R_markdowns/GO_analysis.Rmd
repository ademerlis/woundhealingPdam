---
title: "GO_analysis"
author: "allyson_demerlis"
date: "2022-10-25"
output: html_document
---

This markdown is for the Gene Ontology (GO) enrichment analysis using the package "topGO" (Alexa et al. 2006). 

# Install and load necessary packages
```{r, install/load packages}
#if you need to install all the packages, you need the package "BiocManager" first.
# if (!require("BiocManager",quietly=TRUE))
#   install.packages("BiocManager")
#Now you can use BiocManager to install pacakges like DESeq2
#BiocManager::install("DESeq2")

library(tidyverse) 
library(topGO) # needs BiocManager
library(GO.db) # needs BiocManager
library(Rgraphviz) # needs BiocManager
library(scales) #for GO dot plot
library(viridis) #for GO dot plot
```

# Import DDS objects for hours
```{r}
dds_1 <- readRDS("dds_1.rds")
res_h1 <- results(dds_1)

dds_2 <- readRDS("dds_2.rds")
res_h2 <- results(dds_2)

dds_4 <- readRDS("dds_4.rds")
res_h4 <- results(dds_4)
```


# topGO analysis (Molecular Function)
```{r}
#following Michael Connelly's code (github)

#Input required *P. damicornis* GO annotation data and construct Gene-to-GO object for custom annotation mapping
GO_geneID<-readMappings(file="../input_files/pdam_genome_GOgenes.txt") #Mike made this file

geneID_GO <- inverseList(GO_geneID)
str(head(geneID_GO))

#Generate gene universe and GO universe from Gene-to-GO and GO-to-Gene objects
geneNames <- names(geneID_GO)
str(head(geneNames))

GONames <- names(GO_geneID)
str(head(GONames))
```

Hour 0 had no annotations so no GO analysis

# Hour 1

## topGO analysis Hour 1 Molecular Function (MF) 

#both up and downregulated genes combined
```{r}
#label differentially expressed genes as '1' and non-significant genes as '0'
res_h1_GO<-as.data.frame(res_h1)
res_h1_GO<- res_h1_GO%>%mutate(Group=case_when(padj<0.05~"1",padj>=0.05~"0"))
res_h1_GO<-na.omit(res_h1_GO)

#create the gene universe
gene_universe_h1<-as.numeric(res_h1_GO$Group)
gene_universe_h1<-factor(gene_universe_h1)
names(gene_universe_h1) <- rownames(res_h1_GO) 

#create topGO data object
GO_MF_h1 <-new("topGOdata",
                ontology="MF",
                allGenes=gene_universe_h1,
                nodeSize=10,
                annotationFun=annFUN.gene2GO,
                gene2GO = geneID_GO)

# test to identify enriched gene ontology terms
GO_MF_h1_resultFisherclassic<-runTest(GO_MF_h1,algorithm = "classic", statistic = "fisher")

#generate results table
GO_MF_h1_resultstable<-GenTable(GO_MF_h1, 
                                Fisherclassic = GO_MF_h1_resultFisherclassic,
                                topNodes = 50)

showSigOfNodes(GO_MF_h1,score(GO_MF_h1_resultFisherclassic),firstSigNodes = 5,useInfo = 'all')

GO_MF_h1_resultstable %>% filter(Significant >= 1) %>% mutate(hour=1)-> sigGO_MF_h1 #filter for genes from this time point that are significantly associated with the GO terms (which are also significantly enriched)
```

## splitting up- and down-regulated genes based on log2fold change for hour 1

### Up-regulated genes in hour 1
```{r}
#label differentially expressed genes as '1' and non-significant genes as '0'
res_GO_h1_up <- as.data.frame(res_h1) %>%
  drop_na(padj) %>% 
  mutate(Group=case_when(padj<0.05 & log2FoldChange > 0 ~"1", TRUE ~ "0")) #selecting log2fold change level of 0

res_GO_h1_up %>% filter(Group == "1") #26 genes

#create the gene universe
gene_universe_h1_up <-as.numeric(res_GO_h1_up$Group)
length(gene_universe_h1_up) #18,777 genes
gene_universe_h1_up <-factor(gene_universe_h1_up)
names(gene_universe_h1_up) <- rownames(res_GO_h1_up) 

#create topGO data object
GO_MF_h1_up <-new("topGOdata",
                ontology="MF",
                allGenes=gene_universe_h1_up,
                nodeSize=10,
                annotationFun=annFUN.gene2GO,
                gene2GO = geneID_GO)

# tests to identify enriched gene ontology terms
GO_MF_h1_up_resultFisherclassic<-runTest(GO_MF_h1_up,algorithm = "classic", statistic = "fisher")

#generate results table
GO_MF_h1_up_resultstable<-GenTable(GO_MF_h1_up,
                                Fisherclassic = GO_MF_h1_up_resultFisherclassic,
                                topNodes = 50)

showSigOfNodes(GO_MF_h1_up,score(GO_MF_h1_up_resultFisherclassic),firstSigNodes = 5,useInfo = 'all')

GO_MF_h1_up_resultstable %>% 
  filter(Significant >= 1) %>% 
  mutate(hour=1) %>% 
  mutate(regulation_direction = "Up") %>% 
  dplyr::select(GO.ID:Fisherclassic, hour, regulation_direction) %>% 
  filter(Fisherclassic < 0.05) -> sigGO_MF_h1_up #filter for genes from this time point that are significantly associated with the GO terms (which are also significantly enriched)
```


### Down-regulated genes in hour 1
```{r}
#label differentially expressed genes as '1' and non-significant genes as '0'
res_GO_h1_down <- as.data.frame(res_h1) %>%
  drop_na(padj) %>% 
  mutate(Group=case_when(padj<0.05 & log2FoldChange < 0 ~"1", TRUE ~ "0")) #selecting log2fold change level of 0

res_GO_h1_down %>% filter(Group == "1") #49 genes

#create the gene universe
gene_universe_h1_down <-as.numeric(res_GO_h1_down$Group)
length(gene_universe_h1_down) #18,777 genes
gene_universe_h1_down <-factor(gene_universe_h1_down)
names(gene_universe_h1_down) <- rownames(res_GO_h1_down) 

#create topGO data object
GO_MF_h1_down <-new("topGOdata",
                ontology="MF",
                allGenes=gene_universe_h1_down,
                nodeSize=10,
                annotationFun=annFUN.gene2GO,
                gene2GO = geneID_GO)

# tests to identify enriched gene ontology terms
GO_MF_h1_down_resultFisherclassic<-runTest(GO_MF_h1_down,algorithm = "classic", statistic = "fisher")

#generate results table
GO_MF_h1_down_resultstable<-GenTable(GO_MF_h1_down,
                                Fisherclassic = GO_MF_h1_down_resultFisherclassic,
                                topNodes = 50)

showSigOfNodes(GO_MF_h1_down,score(GO_MF_h1_down_resultFisherclassic),firstSigNodes = 5,useInfo = 'all')

GO_MF_h1_down_resultstable %>% 
  filter(Significant >= 1) %>% 
  mutate(hour=1) %>% 
  mutate(regulation_direction = "down") %>% 
  dplyr::select(GO.ID:Fisherclassic, hour, regulation_direction) %>% 
  filter(Fisherclassic < 0.05) -> sigGO_MF_h1_down #filter for genes from this time point that are significantly associated with the GO terms (which are also significantly enriched)
```

## topGO analysis Hour 2 Molecular Function (MF)
```{r}
#label differentially expressed genes as '1' and non-significant genes as '0'
res_h2_GO<-as.data.frame(res_h2)
res_h2_GO<- res_h2_GO%>%mutate(Group=case_when(padj<0.05~"1",padj>=0.05~"0"))
res_h2_GO<-na.omit(res_h2_GO)

#create the gene universe
gene_universe_h2<-as.numeric(res_h2_GO$Group)
gene_universe_h2<-factor(gene_universe_h2)
names(gene_universe_h2) <- rownames(res_h2_GO) 

#create topGO data object
GO_MF_h2 <-new("topGOdata",
                ontology="MF",
                allGenes=gene_universe_h2,
                nodeSize=10,
                annotationFun=annFUN.gene2GO,
                gene2GO = geneID_GO)

# tests to identify enriched gene ontology terms
GO_MF_h2_resultFisher01<-runTest(GO_MF_h2,algorithm = "weight01", statistic = "fisher")
GO_MF_h2_resultFisherclassic<-runTest(GO_MF_h2,algorithm = "classic", statistic = "fisher")
GO_MF_h2_resultclassicKS <- runTest(GO_MF_h2, algorithm = "classic", statistic = "ks")
GO_MF_h2_resultelimKS <- runTest(GO_MF_h2, algorithm = "elim", statistic = "ks")


#generate results table
GO_MF_h2_resultstable<-GenTable(GO_MF_h2, 
                                Fisher01 = GO_MF_h2_resultFisher01,
                                Fisherclassic = GO_MF_h2_resultFisherclassic,
                                classicKS = GO_MF_h2_resultclassicKS,
                                elimKS = GO_MF_h2_resultelimKS,
                                topNodes = 50)

showSigOfNodes(GO_MF_h2,score(GO_MF_h2_resultelimKS),firstSigNodes = 5,useInfo = 'all')

GO_MF_h2_resultstable %>% filter(Significant >= 1) %>% mutate(hour=2)-> sigGO_MF_h2 #filter for genes from this time point that are significantly associated with the GO terms (which are also significantly enriched)
```

## topGO analysis Hour 4 Molecular Function (MF)
```{r}
#label differentially expressed genes as '1' and non-significant genes as '0'
res_h4_GO<-as.data.frame(res_h4)
res_h4_GO<- res_h4_GO%>%mutate(Group=case_when(padj<0.05~"1",padj>=0.05~"0"))
res_h4_GO<-na.omit(res_h4_GO)

#create the gene universe
gene_universe_h4<-as.numeric(res_h4_GO$Group)
gene_universe_h4<-factor(gene_universe_h4)
names(gene_universe_h4) <- rownames(res_h4_GO) 

#create topGO data object
GO_MF_h4 <-new("topGOdata",
                ontology="MF",
                allGenes=gene_universe_h4,
                nodeSize=10,
                annotationFun=annFUN.gene2GO,
                gene2GO = geneID_GO)

# tests to identify enriched gene ontology terms
GO_MF_h4_resultFisher01<-runTest(GO_MF_h4,algorithm = "weight01", statistic = "fisher")
GO_MF_h4_resultFisherclassic<-runTest(GO_MF_h4,algorithm = "classic", statistic = "fisher")
GO_MF_h4_resultclassicKS <- runTest(GO_MF_h4, algorithm = "classic", statistic = "ks")
GO_MF_h4_resultelimKS <- runTest(GO_MF_h4, algorithm = "elim", statistic = "ks")


#generate results table
GO_MF_h4_resultstable<-GenTable(GO_MF_h4, 
                                Fisher01 = GO_MF_h4_resultFisher01,
                                Fisherclassic = GO_MF_h4_resultFisherclassic,
                                classicKS = GO_MF_h4_resultclassicKS,
                                elimKS = GO_MF_h4_resultelimKS,
                                topNodes = 50)

showSigOfNodes(GO_MF_h4,score(GO_MF_h4_resultelimKS),firstSigNodes = 5,useInfo = 'all')

GO_MF_h4_resultstable %>% filter(Significant >= 1) %>% mutate(hour=4)-> sigGO_MF_h4 #filter for genes from this time point that are significantly associated with the GO terms (which are also significantly enriched)
```


## combine all significant gene GO lists per hour and visualize as table
```{r}
full_join(sigGO_MF_h1, sigGO_MF_h2) %>% full_join(., sigGO_MF_h4) %>%  #144 GO terms total
  filter(Fisherclassic < 0.05) #25 GO terms now
  #write_csv("GO_MF_allhours.csv")

#dot plot
full_join(sigGO_MF_h1, sigGO_MF_h2) %>% full_join(., sigGO_MF_h4) %>%
  filter(Fisherclassic < 0.05) %>% 
  mutate(Fisherclassic = as.numeric(Fisherclassic)) %>% 
  mutate(Annotated = as.numeric(Annotated)) %>% 
ggplot(data=., aes(x=-log(Fisherclassic), y=reorder(Term, -Fisherclassic))) +
    geom_point(aes(size=Annotated, color=-log(Fisherclassic))) +
    scale_color_viridis(option="plasma") +
  labs(x="-log P-Value", y="Gene Ontology Term Description", title=paste("Significant Molecular Functions"), color = "-log(P-value)") +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 30)) +
  theme_bw() +
  facet_grid(vars(hour), scales = "free") + 
  scale_size(range = c(2,6))
##ggsave("significantMF_GO_perhour.pdf")

#need to make one that has the GO term next to it so I can easily google it for the illustrator manual edits
full_join(sigGO_MF_h1, sigGO_MF_h2) %>% full_join(., sigGO_MF_h4) %>%
  filter(Fisherclassic < 0.05) %>% 
  mutate(Fisherclassic = as.numeric(Fisherclassic)) %>% 
  mutate(Annotated = as.numeric(Annotated)) %>% 
  mutate(GO_term=str_c(GO.ID,Term, sep=" ")) %>% 
  ggplot(data=., aes(x=-log(Fisherclassic), y=reorder(GO_term, -Fisherclassic))) +
    geom_point(aes(size=Annotated, color=-log(Fisherclassic))) +
    scale_color_viridis(option="plasma") +
  labs(x="-log P-Value", y="Gene Ontology Term Description", title=paste("Significant Molecular Functions"), color = "-log(P-value)") +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50)) +
  theme_bw() +
  facet_grid(vars(hour), scales = "free") + 
  scale_size(range = c(2,6))
```

