---
title: "WGCNA"
author: "allyson_demerlis"
date: "2023-06-01"
output: html_document
---

```{r setup, include=FALSE}
library(WGCNA) #install using BiocManager
library(tidyverse)
library(DESeq2)

#The following setting is important, do not omit. 
options(stringsAsFactors=FALSE)
allowWGCNAThreads()
```

## Attempt 1: Following traditional WGCNA tutorial with the DDS LRT object (all time points control vs. wounded)
```{r}
#read in dataset (needs to be a subset of original counts matrix - in SCTLD jamboree, we used a subset of the dds object so I'll follow that code:  https://github.com/ademerlis/sctld_jamboree/blob/master/my_code/sctld_mcav.Rmd)

dds_LRT <- readRDS(file = "ddsLRT.rds")
nrow(dds_LRT) #21267 genes
keep_98 <- rowSums(counts(dds_LRT) >= 10) > (ncol(dds_LRT)*0.98) #counts over 10 in 98% of samples
dds_LRT_wgcna <- dds_LRT[keep_98,]
nrow(dds_LRT_wgcna) #14224 genes

#all these things are recommended in the WGCNA FAQ : https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/faq.html

#you need to normalize expression data for WGCNA using VST transformation
vst_lrt_wgcna <- vst(dds_LRT_wgcna, blind = FALSE) #blind = FALSE because you want it to take into account the dds model
countdata_vst_lrt_wgcna <- assay(vst_lrt_wgcna)
datExpr_lrt <- t(countdata_vst_lrt_wgcna)
dim(datExpr_lrt) #24 samples, 14224 genes
```

Checking for excessive missing values and identifying outliers
```{r}
gsg = WGCNA::goodSamplesGenes(datExpr_lrt, verbose = 3)

gsg$allOK #TRUE = all genes passed the cuts
```

Initial sample clustering to see if there are any visible outliers still
```{r}
sampleTree = hclust(dist(datExpr_lrt), method = "average");
sizeGrWindow(12,9)
par(cex=0.6);
par(mar=c(0,4,2,0)) 
plot(sampleTree,main="Sample clustering to detect outliers",sub="",xlab="",cex.lab=1.5, cex.axis=1.5,cex.main=2)

#no obvious outliers in this dendrogram
```


Choose soft-thresholding power
```{r}
powers=c(c(1:10),seq(from=12,to=20,by=2))

#network topology analysis function to pick soft threshold
sft=pickSoftThreshold(datExpr_lrt,powerVector=powers,verbose=5) #this takes a very long time, make sure you run allowWGCNAthreads() beforehand

#plot results
sizeGrWindow(9, 5)
par(mfrow = c(1,2));
cex1=0.9;
#scale-free topology fit index as a function of the soft-thresholding power
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
                               xlab="Soft Threshold (power)", ylab = "Scale Free Topology Model Fit, signed R^2", type = "n", main = paste("Scale independence"));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2], labels = powers, cex=cex1, col="red")
abline(h=0.8, col="red") #i think you just want the h cut-off to be as high as possible and still able to select a number
#mean connectivity as a function of the soft-thresholding power
plot(sft$fitIndices[,1],sft$fitIndices[,5], xlab="Soft Threshold (power)",ylab="Mean Connectivity",type="n", main=paste("Mean connectivity"))
text(sft$fitIndices[,1],sft$fitIndices[,5],labels=powers,cex=cex1,col="red")

#based on these graphs, you pick the lowest red number (power) for which the scale-free topology index reaches the highest possible number (in this dataset 0.8 instead of 0.9 because it just doesn't reach that high for some reason - lack of homogeneity of samples perhaps?)

#based on the intersection of the abline in line 135, power = 16
```

Co-expression similarity and adjacency, and Topological Overlap Matrix (TOM)
```{r}
#WARNING: this part takes hours

softPower = 16;
adjacency = adjacency(datExpr_lrt, 
                      corFnc = "bicor", #midweight bi-correlation (more robust to outliers than pearson correlation)
                       power = softPower,
                      type = "signed"); #signed means it knows down vs. upregulation, which is more biologically relevant
#turn adjacency into topological overlap
TOM=TOMsimilarity(adjacency,
                  TOMType = "signed",
                  verbose = 5);
dissTOM = 1-TOM #TOM is a measure of similarity, but for clustering you want to see the dissimilarity
rm(adjacency) #clear up vector memory 
```


Clustering using TOM
```{r}
geneTree = hclust(as.dist(dissTOM), method = "average");
sizeGrWindow(12,9)
plot(geneTree, xlab="", sub="", main = "Gene clustering on TOM-based dissimilarity", labels = FALSE, hang = 0.04);
```


```{r}
minModulesize = 30;
#module identification using dynamic tree cut:
dynamicMode = cutreeDynamic(dendro = geneTree, distM = dissTOM,
                            deepSplit = 2, pamRespectsDendro = FALSE,
                            minClusterSize = minModulesize)
table(dynamicMode)
```


```{r}
dynamicColors = labels2colors(dynamicMode)
table(dynamicColors)
sizeGrWindow(8,6)
plotDendroAndColors(geneTree, dynamicColors, "Dynamic Tree Cut",
                    dendroLabels = FALSE, hang = 0.03,
                    addGuide = TRUE, guideHang = 0.05,
                    main = "Gene dendrogram and module colors")
```

Merge modules whose expression profiles are very similar
```{r}
#Calculate eigengenes
MEList = moduleEigengenes(datExpr_lrt, colors=dynamicColors)
MEs = MEList$eigengenes
#Calculate dissimilarity of module eigengenes
MEDiss = 1-cor(MEs);
METree = hclust(as.dist(MEDiss), method = "average");

sizeGrWindow(7,6)
plot(METree, main = "Clustering of module eigengenes",
     xlab = "", sub = "")
MEDissThres = 0.25
abline(h=MEDissThres, col = "red")
merge = mergeCloseModules(datExpr_lrt, dynamicColors, cutHeight = MEDissThres, verbose = 3)
mergedColors = merge$colors;
mergedMEs=merge$newMEs;
sizeGrWindow(12,9)
plotDendroAndColors(geneTree, cbind(dynamicColors, mergedColors),
                    c("Dynamic Tree Cut", "Merged dynamic"),
                    dendroLabels = FALSE, hang = 0.03,
                    addGuide=TRUE, guideHang = 0.05)

moduleColors = mergedColors
colorOrder = c("grey", standardColors(50));
moduleLabels = match(moduleColors, colorOrder)-1;
MEs=mergedMEs

#save files so you don't have to run TOM again
save(MEs, moduleLabels, moduleColors, geneTree, file = "WGCNAnetworkconstruction.RData")
```


Quantifying module-trait associations
```{r}
nGenes = ncol(datExpr_lrt)
nSamples = nrow(datExpr_lrt)
MEs0 = moduleEigengenes(datExpr_lrt, moduleColors)$eigengenes
MEs0 = orderMEs(MEs0)

#the following code I got from here: https://bioinformaticsworkbook.org/tutorials/wgcna.html#gsc.tab=0

module_order = names(MEs0) %>% gsub("ME","", .)
MEs0$samples = row.names(MEs0)

mME = MEs0 %>%
  pivot_longer(-samples) %>%
  mutate(
    name = gsub("ME", "", name),
    name = factor(name, levels = module_order)
  )

mME %>% ggplot(., aes(x=samples, y=name, fill=value)) +
  geom_tile() +
  theme_bw() +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    midpoint = 0,
    limit = c(-1,1)) +
  theme(axis.text.x = element_text(angle=90)) +
  labs(title = "Module-trait Relationships", y = "Modules", fill="corr")
```

read in metadata file for correlating traits
```{r}
metadata <- read.csv("../input_files/metadata_forcorrWGCNA.csv")
metadata <- column_to_rownames(metadata, var="sample")
```


```{r}
table(rownames(metadata) == rownames(datExpr_lrt)) #this needs to be TRUE

moduleTraitCor = cor(MEs, metadata, use = "p")
moduleTraitPvalue = corPvalueStudent(moduleTraitCor, nSamples)

sizeGrWindow(10,6)
textMatrix = paste(signif(moduleTraitCor, 2), "\n(",
                   signif(moduleTraitPvalue, 1), ")", sep = "")
dim(textMatrix) = dim(moduleTraitCor)
pdf(file="moduletraitrelationships.pdf", width = 10, height = 7)
par(mar=c(6,8.5,3,3));
labeledHeatmap(Matrix=moduleTraitCor, 
               xLabels=names(metadata), 
               yLabels=names(MEs), 
               ySymbols=names(MEs), 
               colorLabels=FALSE, 
               colors=blueWhiteRed(50), 
               textMatrix=textMatrix, 
               setStdMargins=FALSE, 
               cex.text=0.5, 
               zlim=c(-1,1),
               main=paste("Module-trait relationships"))

#The modules I want to focus on are the ones that are opposite colors for control vs. wounded within a time point.
```


Gene relationship to trait of interest (condition) and important modules
```{r}
condition = as.data.frame(metadata$condition);
names(condition) = "condition" 
#control = 2 and wounded = 1

modNames = substring(names(MEs), 3)

geneModuleMembership = as.data.frame(cor(datExpr_lrt, MEs, use = "p"));
MMPvalue = as.data.frame(corPvalueStudent(as.matrix(geneModuleMembership), nSamples));
names(geneModuleMembership) = paste("MM", modNames, sep="");
names(MMPvalue) = paste("p.MM", modNames, sep="");

geneTraitSignificance = as.data.frame(cor(datExpr_lrt, condition, use = "p"));
GSPvalue = as.data.frame(corPvalueStudent(as.matrix(geneTraitSignificance), nSamples));

names(geneTraitSignificance) = paste("GS.", names(condition), sep="");
names(GSPvalue) = paste("p.GS.", names(condition), sep="")
```


First module to look at for condition: MEdarkgreen
```{r}
module = "darkgreen"
column = match(module, modNames);
moduleGenes = moduleColors == module;

sizeGrWindow(7,7);
par(mfrow = c(1,1));
verboseScatterplot(abs(geneModuleMembership[moduleGenes, column]),
                   abs(geneTraitSignificance[moduleGenes, 1]),
                   xlab = paste("Module Membership in", module, "module"),
                   ylab = "Gene significance for condition",
                   main = paste("Module membership vs. gene significance\n"),
                   cex.main = 1.2, cex.lab = 1.2, cex.axis = 1.2, col = module)

#this is not significantly correlated at all 
```


second module to look at for condition: MEbrown
```{r}
module = "brown"
column = match(module, modNames);
moduleGenes = moduleColors == module;

sizeGrWindow(7,7);
par(mfrow = c(1,1));
verboseScatterplot(abs(geneModuleMembership[moduleGenes, column]),
                   abs(geneTraitSignificance[moduleGenes, 1]),
                   xlab = paste("Module Membership in", module, "module"),
                   ylab = "Gene significance for condition",
                   main = paste("Module membership vs. gene significance\n"),
                   cex.main = 1.2, cex.lab = 1.2, cex.axis = 1.2, col = module)

#this is not significantly correlated at all 
```


third module to look at for condition: MEbrown4
```{r}
module = "brown4"
column = match(module, modNames);
moduleGenes = moduleColors == module;

sizeGrWindow(7,7);
par(mfrow = c(1,1));
verboseScatterplot(abs(geneModuleMembership[moduleGenes, column]),
                   abs(geneTraitSignificance[moduleGenes, 1]),
                   xlab = paste("Module Membership in", module, "module"),
                   ylab = "Gene significance for condition",
                   main = paste("Module membership vs. gene significance\n"),
                   cex.main = 1.2, cex.lab = 1.2, cex.axis = 1.2, col = module)

#this is not significantly correlated at all 
```





## Attempt 2: 